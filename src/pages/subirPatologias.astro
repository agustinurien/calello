---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import SubirPatologia from "../components/subirPatologia/SubirPatologia";
---

<Layout>
  <div class="subirNoticiaContainer" id="container">
    <div id="login-area" style="display:none;">
      <p>Ingrese la contraseña para acceder</p>
      <form id="login-form" autocomplete="off">
        <input
          type="password"
          name="password"
          placeholder="Contraseña"
          required
          autocomplete="off"
        />
        <button type="submit">Entrar</button>
      </form>
      <p id="error-msg" style="color: red; display: none;">Contraseña incorrecta</p>
    </div>
    <div id="protegido" style="display:none;">
      <SubirPatologia client:load />
    </div>
  </div>
</Layout>

<script type="module">
  const loginArea = document.getElementById('login-area');
  const protegido = document.getElementById('protegido');
  const form = document.getElementById('login-form');
  const errorMsg = document.getElementById('error-msg');

  // Mostrar la vista correcta según localStorage
  if (localStorage.getItem("autorizado") === "true") {
    protegido.style.display = "block";
  } else {
    loginArea.style.display = "block";
  }

  if (form) {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorMsg.style.display = 'none';

    try {
      const formData = new FormData(form);
      const res = await fetch('/api/login', {
        method: 'POST',
        body: formData,
      });

      if (!res.ok) {
        throw new Error(`Error en la respuesta: ${res.status} ${res.statusText}`);
      }

      const data = await res.json();

      if (data.autorizado) {
        localStorage.setItem("autorizado", "true");
        loginArea.style.display = "none";
        protegido.style.display = "block";
      } else {
        errorMsg.style.display = 'block';
      }
    } catch (error) {
      console.error("Error en el login:", error);
      errorMsg.textContent = "Ocurrió un error. Intenta nuevamente.";
      errorMsg.style.display = 'block';
    }
  });
}
</script>



<style>
  .subirNoticiaContainer {
    width: 100%;

    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-color: #848484;
    padding: 120px 0px;

    box-sizing: border-box;
  }
  
</style>
